# ç›®æ ‡ï¼šäº†è§£ä»€ä¹ˆæ˜¯ä¹¾å¤

# ä¹¾å¤ä»‹ç»

qiankun æ˜¯ä¸€ä¸ªåŸºäº [single-spa](https://github.com/CanopyTax/single-spa) çš„[å¾®å‰ç«¯](https://micro-frontends.org/)å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

qiankun å­µåŒ–è‡ªèš‚èšé‡‘èç§‘æŠ€åŸºäºå¾®å‰ç«¯æ¶æ„çš„äº‘äº§å“ç»Ÿä¸€æ¥å…¥å¹³å°ï¼Œåœ¨ç»è¿‡ä¸€æ‰¹çº¿ä¸Šåº”ç”¨çš„å……åˆ†æ£€éªŒåŠæ‰“ç£¨åï¼Œæˆ‘ä»¬å°†å…¶å¾®å‰ç«¯å†…æ ¸æŠ½å–å‡ºæ¥å¹¶å¼€æºï¼Œå¸Œæœ›èƒ½åŒæ—¶å¸®åŠ©ç¤¾åŒºæœ‰ç±»ä¼¼éœ€æ±‚çš„ç³»ç»Ÿæ›´æ–¹ä¾¿çš„æ„å»ºè‡ªå·±çš„å¾®å‰ç«¯ç³»ç»Ÿï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›é€šè¿‡ç¤¾åŒºçš„å¸®åŠ©å°† qiankun æ‰“ç£¨çš„æ›´åŠ æˆç†Ÿå®Œå–„ã€‚

ç›®å‰ qiankun å·²åœ¨èš‚èšå†…éƒ¨æœåŠ¡äº†è¶…è¿‡ 200+ çº¿ä¸Šåº”ç”¨ï¼Œåœ¨æ˜“ç”¨æ€§åŠå®Œå¤‡æ€§ä¸Šï¼Œç»å¯¹æ˜¯å€¼å¾—ä¿¡èµ–çš„ã€‚

# ç›®æ ‡ï¼šäº†è§£ä»€ä¹ˆæ˜¯å¾®å‰ç«¯

> å¾®å‰ç«¯æ˜¯ä¸€ç§å¤šä¸ªå›¢é˜Ÿé€šè¿‡ç‹¬ç«‹å‘å¸ƒåŠŸèƒ½çš„æ–¹å¼æ¥å…±åŒæ„å»ºç°ä»£åŒ– web åº”ç”¨çš„æŠ€æœ¯æ‰‹æ®µåŠæ–¹æ³•ç­–ç•¥ã€‚

å¾®å‰ç«¯æ¶æ„å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒä»·å€¼ï¼š

- æŠ€æœ¯æ ˆæ— å…³
  ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå¾®åº”ç”¨å…·å¤‡å®Œå…¨è‡ªä¸»æƒ

- ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²
  å¾®åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå‰åç«¯å¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°

- å¢é‡å‡çº§

  åœ¨é¢å¯¹å„ç§å¤æ‚åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆéš¾å¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç³»ç»Ÿåšå…¨é‡çš„æŠ€æœ¯æ ˆå‡çº§æˆ–é‡æ„ï¼Œè€Œå¾®å‰ç«¯æ˜¯ä¸€ç§éå¸¸å¥½çš„å®æ–½æ¸è¿›å¼é‡æ„çš„æ‰‹æ®µå’Œç­–ç•¥

- ç‹¬ç«‹è¿è¡Œæ—¶
  æ¯ä¸ªå¾®åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«

å¾®å‰ç«¯æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨ä¸€ä¸ªç›¸å¯¹é•¿çš„æ—¶é—´è·¨åº¦ä¸‹ï¼Œç”±äºå‚ä¸çš„äººå‘˜ã€å›¢é˜Ÿçš„å¢å¤šã€å˜è¿ï¼Œä»ä¸€ä¸ªæ™®é€šåº”ç”¨æ¼”å˜æˆä¸€ä¸ªå·¨çŸ³åº”ç”¨([Frontend Monolith](https://www.youtube.com/watch?v=pU1gXA0rfwc))åï¼Œéšä¹‹è€Œæ¥çš„åº”ç”¨ä¸å¯ç»´æŠ¤çš„é—®é¢˜ã€‚è¿™ç±»é—®é¢˜åœ¨ä¼ä¸šçº§ Web åº”ç”¨ä¸­å°¤å…¶å¸¸è§ã€‚

# ç›®æ ‡ï¼šäº†è§£ä¹¾å¤çš„ç‰¹æ€§

- ğŸ“¦ **åŸºäº [single-spa](https://github.com/CanopyTax/single-spa)** å°è£…ï¼Œæä¾›äº†æ›´åŠ å¼€ç®±å³ç”¨çš„ APIã€‚
- ğŸ“± **æŠ€æœ¯æ ˆæ— å…³**ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ ä½¿ç”¨/æ¥å…¥ï¼Œä¸è®ºæ˜¯ React/Vue/Angular/JQuery è¿˜æ˜¯å…¶ä»–ç­‰æ¡†æ¶ã€‚
- ğŸ’ª **HTML Entry æ¥å…¥æ–¹å¼**ï¼Œè®©ä½ æ¥å…¥å¾®åº”ç”¨åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚
- ğŸ›¡ **æ ·å¼éš”ç¦»**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚
- ğŸ§³ **JS æ²™ç®±**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´ å…¨å±€å˜é‡/äº‹ä»¶ ä¸å†²çªã€‚
- âš¡ï¸ **èµ„æºé¢„åŠ è½½**ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é¢„åŠ è½½æœªæ‰“å¼€çš„å¾®åº”ç”¨èµ„æºï¼ŒåŠ é€Ÿå¾®åº”ç”¨æ‰“å¼€é€Ÿåº¦ã€‚
- ğŸ”Œ **umi æ’ä»¶**ï¼Œæä¾›äº† [@umijs/plugin-qiankun](https://github.com/umijs/plugins/tree/master/packages/plugin-qiankun) ä¾› umi åº”ç”¨ä¸€é”®åˆ‡æ¢æˆå¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

# ç›®æ ‡ï¼šä» 0 åˆ° 1 æ­å»ºä¸€ä¸ªå¾®å‰ç«¯åº”ç”¨ï¼Œ[çº¿ä¸Šåœ°å€](https://gitee.com/thomaslwq/qkdemo)

## å…‹éš†çº¿ä¸Šä¾‹å­è§‚çœ‹è¿è¡Œæ•ˆæœ

1. å…‹éš†çº¿ä¸Šä»£ç 

```bash
git clone https://gitee.com/thomaslwq/qkdemo.git
```

2. è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œä»¥æ­¤æ‰§è¡Œå®‰è£…ä¾èµ–å‘½ä»¤ç„¶åæ‰§è¡Œ

```bash
cd qkdemo
// æ‰“å¼€ä¸åŒç»ˆç«¯ ä¾æ¬¡è¿è¡Œä»¥ä¸‹å‘½ä»¤
npm i
npm run install:father
npm run install:react16
npm run start:react16
npm run install:vue
npm run start:vue
npm run install:main
npm run start:main
```

3. æ‰§è¡Œçœ‹åˆ°æ•ˆæœ

![1636017795137](README.assets/1636017795137.png)

## ç›®æ ‡ï¼šç†è§£æ¡ˆä¾‹å„ä¸ªç›®å½•çš„ä½œç”¨

![1636018019507](README.assets/1636018019507.png)

## ç›®æ ‡ï¼šäº†è§£å¾®å‰ç«¯çš„ä¸»åº”ç”¨å…¥å£çš„æ–‡ä»¶ç›®å½•å’Œä½œç”¨

![1636018113954](README.assets/1636018113954.png)

## ç›®æ ‡ï¼šçŸ¥é“å¦‚ä½•ä¿®æ”¹ React é¡¹ç›®æˆä¸ºä¸€ä¸ªä¹¾å¤å¾®å‰ç«¯åº”ç”¨

ä»¥ `create react app` ç”Ÿæˆçš„ `react 16` é¡¹ç›®ä¸ºä¾‹ï¼Œæ­é… `react-router-dom` 5.xã€‚

1. åœ¨ `src` ç›®å½•æ–°å¢ `public-path.js`ï¼š

   ```js
   if (window.__POWERED_BY_QIANKUN__) {
     __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__
   }
   ```

2. è®¾ç½® `history` æ¨¡å¼è·¯ç”±çš„ `base`ï¼š

   ```html
   <BrowserRouter basename={window.__POWERED_BY_QIANKUN__ ? '/app-react' : '/'}>
   ```

3. å…¥å£æ–‡ä»¶ `index.js` ä¿®æ”¹ï¼Œä¸ºäº†é¿å…æ ¹ id `#root` ä¸å…¶ä»–çš„ DOM å†²çªï¼Œéœ€è¦é™åˆ¶æŸ¥æ‰¾èŒƒå›´ã€‚

   ```js
   import './public-path'
   import React from 'react'
   import ReactDOM from 'react-dom'
   import App from './App'
   import * as serviceWorker from './serviceWorker'

   function render(props) {
     const { container } = props
     ReactDOM.render(
       <App />,
       container
         ? container.querySelector('#root')
         : document.querySelector('#root')
     )
   }

   function storeTest(props) {
     props.onGlobalStateChange(
       (value, prev) =>
         console.log(`[onGlobalStateChange - ${props.name}]:`, value, prev),
       true
     )
     props.setGlobalState({
       ignore: props.name,
       user: {
         name: props.name
       }
     })
   }

   if (!window.__POWERED_BY_QIANKUN__) {
     render({})
   }

   export async function bootstrap() {
     console.log('[react16] react app bootstraped')
   }

   export async function mount(props) {
     console.log('[react16] props from main framework', props)
     storeTest(props)
     render(props)
   }

   export async function unmount(props) {
     const { container } = props
     ReactDOM.unmountComponentAtNode(
       container
         ? container.querySelector('#root')
         : document.querySelector('#root')
     )
   }

   // If you want your app to work offline and load faster, you can change
   // unregister() to register() below. Note this comes with some pitfalls.
   // Learn more about service workers: https://bit.ly/CRA-PWA
   serviceWorker.unregister()
   ```

4. ä¿®æ”¹ `webpack` é…ç½®

   å®‰è£…æ’ä»¶ `@rescripts/cli`ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„æ’ä»¶ï¼Œä¾‹å¦‚ `react-app-rewired`ã€‚

   ```dash
   npm i -D @rescripts/cli
   ```

   æ ¹ç›®å½•æ–°å¢ `.rescriptsrc.js`ï¼š

   ```js
   const { name } = require('./package')

   module.exports = {
     webpack: (config) => {
       config.output.library = `${name}-[name]`
       config.output.libraryTarget = 'umd'
       config.output.jsonpFunction = `webpackJsonp_${name}`
       config.output.globalObject = 'window'

       return config
     },

     devServer: (_) => {
       const config = _

       config.headers = {
         'Access-Control-Allow-Origin': '*'
       }
       config.historyApiFallback = true
       config.hot = false
       config.watchContentBase = false
       config.liveReload = false

       return config
     }
   }
   ```

   ä¿®æ”¹ `package.json`ï¼š

   ```diff
   -   "start": "react-scripts start",
   +   "start": "rescripts start",
   -   "build": "react-scripts build",
   +   "build": "rescripts build",
   -   "test": "react-scripts test",
   +   "test": "rescripts test",
   -   "eject": "react-scripts eject"
   ```

## ç›®æ ‡ï¼šçŸ¥é“å¦‚ä½•ä¿®æ”¹ Vue é¡¹ç›®ä¸ºä¸€ä¸ª å¾®åº”ç”¨

ä»¥ `vue-cli 3+` ç”Ÿæˆçš„ `vue 2.x` é¡¹ç›®ä¸ºä¾‹ï¼Œ`vue 3` ç‰ˆæœ¬ç­‰ç¨³å®šåå†è¡¥å……ã€‚

1. åœ¨ `src` ç›®å½•æ–°å¢ `public-path.js`ï¼š

   ```js
   if (window.__POWERED_BY_QIANKUN__) {
     // eslint-disable-next-line no-undef
     __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__
   }
   ```

2. å…¥å£æ–‡ä»¶ `main.js` ä¿®æ”¹ï¼Œä¸ºäº†é¿å…æ ¹ id `#app` ä¸å…¶ä»–çš„ DOM å†²çªï¼Œéœ€è¦é™åˆ¶æŸ¥æ‰¾èŒƒå›´ã€‚

   ```js
   import './public-path'
   import Vue from 'vue'
   import VueRouter from 'vue-router'
   import App from './App.vue'
   import routes from './router'
   import store from './store'

   Vue.config.productionTip = false

   let router = null
   let instance = null
   function render(props = {}) {
     const { container } = props
     router = new VueRouter({
       base: window.__POWERED_BY_QIANKUN__ ? '/app-vue/' : '/',
       mode: 'history',
       routes
     })

     instance = new Vue({
       router,
       store,
       render: (h) => h(App)
     }).$mount(container ? container.querySelector('#app') : '#app')
   }

   // ç‹¬ç«‹è¿è¡Œæ—¶
   if (!window.__POWERED_BY_QIANKUN__) {
     render()
   }

   export async function bootstrap() {
     console.log('[vue] vue app bootstraped')
   }
   export async function mount(props) {
     console.log('[vue] props from main framework', props)
     render(props)
   }
   export async function unmount() {
     instance.$destroy()
     instance.$el.innerHTML = ''
     instance = null
     router = null
   }
   ```

3. æ‰“åŒ…é…ç½®ä¿®æ”¹ï¼ˆ`vue.config.js`ï¼‰ï¼š

   ```js
   const { name } = require('./package')
   module.exports = {
     devServer: {
       headers: {
         'Access-Control-Allow-Origin': '*'
       }
     },
     configureWebpack: {
       output: {
         library: `${name}-[name]`,
         libraryTarget: 'umd', // æŠŠå¾®åº”ç”¨æ‰“åŒ…æˆ umd åº“æ ¼å¼
         jsonpFunction: `webpackJsonp_${name}`
       }
     }
   }
   ```

###
